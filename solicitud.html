<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitud de Servicio - Dev Solu</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function(){ emailjs.init('iQg3fXzAKcu42Lk50'); })();
  </script>
  <style>
  body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg,#f0f0f0,#dfe9f3); margin:0; padding:40px 10px; }
  
  .summary { max-width:800px; margin:25px auto; background:#fdfdfd; padding:20px; border-left:6px solid #0056b3; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.05); font-size:14px; white-space: pre-wrap; }
  #uploadProgressContainer { width:100%; background:#eee; border-radius:10px; overflow:hidden; display:none; margin-top:10px; }
  #uploadProgressBar { height:12px; width:0%; background:#0056b3; border-radius:10px; transition: width 0.2s ease; }
  #uploadStatus { font-size:13px; margin-top:5px; color:#555; }
  input[type="file"] { padding:5px; border:none; }
  
  </style>
  <link rel="icon" type="image/x-icon" href="assets/img/Favicon.ico">
  <link rel="stylesheet" href="src/style.css">
</head>
<body>
   <header class="header">
    <img src="assets/img/Favicon.ico" alt="Dev Solu" srcset="">
    <nav class="nav">
      <ul>
        <li><a href="index.html#inicio">Inicio</a></li>
        <li><a href="index.html#servicios">Servicios</a></li>
        <li><a href="portafolio.html">Clientes</a></li>
        <li><a href="index.html#testimonios">Testimonios</a></li>
        <li><a href="index.html#contacto">Contacto</a></li>
      </ul>
    </nav>
    <button class="nav-toggle" id="nav-toggle" aria-label="Abrir menú">&#9776;</button>
  </header>
  <form id="serviceForm">
    <h2 id="h2soli">Solicitud de Servicio</h2>
    <label>Nombre Completo:</label>
    <input type="text" name="nombre" required>

    <label>Empresa:</label>
    <input type="text" name="empresa" placeholder="Nombre de la empresa si aplica">

    <label>Correo Electrónico:</label>
    <input type="email" name="email" required>

    <label>Teléfono:</label>
    <input type="tel" name="telefono" required>

    <label>Referencias (webs, redes o ejemplos que te gusten):</label>
    <textarea name="referencias" placeholder="Links o descripciones de referencias"></textarea>

    <label>Servicio requerido:</label>
    <select name="servicio" required>
      <option value="Sitio Web">Desarrollo de Sitio Web</option>
      <option value="E-commerce">E-commerce</option>
      <option value="Software a medida">Software a medida</option>
      <option value="Mantenimiento">Mantenimiento</option>
    </select>

    <label>Descripción detallada del proyecto:</label>
    <textarea name="descripcion" rows="5" required></textarea>

    <label>Presupuesto estimado:</label>
    <input type="text" name="presupuesto" placeholder="Opcional">

    <label>Plazo deseado:</label>
    <input type="text" name="plazo" placeholder="Ej: 2 semanas">

    <label>Prioridad:</label>
    <select name="prioridad">
      <option value="Normal">Normal</option>
      <option value="Alta">Alta</option>
      <option value="Urgente">Urgente</option>
    </select>

    <label>Adjuntar archivos (si es necesario):</label>
    <input type="file" name="archivos" multiple>

    <div id="uploadProgressContainer">
      <div id="uploadProgressBar"></div>
      <div id="uploadStatus">Subiendo archivos...</div>
    </div>

    <button type="submit">Enviar Solicitud</button>
  </form>

<div class="summary" id="formSummary">Completa el formulario para ver el resumen aquí...</div>

<script>
  // CONFIG
  const WHATSAPP_NUMBER = '18492078083'; // tu número sin +
  const CLOUD_NAME = 'drwkwwbcq';
  const UPLOAD_PRESET = 'devsolu';
  const MAX_EMAIL_LINKS = 10; // máximo enlaces que enviaremos por email

  // DOM
  const form = document.getElementById('serviceForm');
  const summary = document.getElementById('formSummary');
  const progressContainer = document.getElementById('uploadProgressContainer');
  const progressBar = document.getElementById('uploadProgressBar');
  const uploadStatus = document.getElementById('uploadStatus');

  // Helpers
  function updateSummary(){
    const d = new FormData(form);
    const lines = [
      `Nombre: ${d.get('nombre')||''}`,
      `Empresa: ${d.get('empresa')||''}`,
      `Email: ${d.get('email')||''}`,
      `Tel: ${d.get('telefono')||''}`,
      `Servicio: ${d.get('servicio')||''}`,
      `Presupuesto: ${d.get('presupuesto')||''}`,
      `Plazo: ${d.get('plazo')||''}`,
      `Prioridad: ${d.get('prioridad')||''}`,
      `Referencias: ${d.get('referencias')||''}`,
      `Descripción: ${d.get('descripcion')||''}`
    ];
    summary.textContent = lines.join('\n');
  }
  form.addEventListener('input', updateSummary);
  updateSummary();

  // Upload using XHR so we can track progress
  function uploadFileToCloudinary(file, onProgress){
    return new Promise((resolve,reject)=>{
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
      const xhr = new XMLHttpRequest();
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', UPLOAD_PRESET);

      xhr.open('POST', url);
      xhr.upload.onprogress = function(e){ if(e.lengthComputable && onProgress){ onProgress(e.loaded, e.total); } };
      xhr.onload = function(){
        try{ const res = JSON.parse(xhr.responseText); if(res && res.secure_url) resolve({name: file.name, url: res.secure_url}); else reject(new Error('No secure_url')); }
        catch(err){ reject(err); }
      };
      xhr.onerror = function(){ reject(new Error('Upload error')); };
      xhr.send(fd);
    });
  }

  async function uploadFilesWithProgress(fileList){
    const files = Array.from(fileList||[]).filter(f=>f && f.size>0);
    if(!files.length) return [];
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    uploadStatus.textContent = 'Preparando subida...';

    const results = [];
    // track overall progress by bytes
    const totalBytes = files.reduce((s,f)=>s+f.size,0);
    let uploadedBytes = 0;

    for(const file of files){
      try{
        const r = await uploadFileToCloudinary(file, (loaded,total)=>{
          // update overall using uploadedBytes + current loaded
          const percent = Math.round(((uploadedBytes + loaded) / totalBytes) * 100);
          progressBar.style.width = percent + '%';
          uploadStatus.textContent = `Subiendo archivos... ${percent}%`;
        });
        results.push(r);
        uploadedBytes += file.size; // assume fully uploaded
      }catch(err){ console.error('Upload failed', file.name, err); }
    }

    progressBar.style.width = '100%';
    uploadStatus.textContent = 'Carga completa';
    setTimeout(()=>{ progressContainer.style.display='none'; progressBar.style.width='0%'; uploadStatus.textContent=''; }, 1400);
    return results;
  }

  // Shorten URL using is.gd (no key). If CORS blocks this, fallback to original URL.
  async function shortenUrl(url){
    try{
      const api = 'https://is.gd/create.php?format=json&url=' + encodeURIComponent(url);
      const res = await fetch(api);
      if(!res.ok) throw new Error('is.gd failed');
      const j = await res.json();
      if(j && j.shorturl) return j.shorturl;
      return url;
    }catch(e){ console.warn('Shorten failed, using full url', e); return url; }
  }

  // send to EmailJS but ensure no file inputs are sent. We'll clone the form and remove file inputs.
  async function sendEmailOnly(){
    // clone form, remove file inputs
    const cloned = form.cloneNode(true);
    const fileInputs = cloned.querySelectorAll('input[type="file"]');
    fileInputs.forEach(n => n.remove());

    // append short file links hidden fields already present in original form
    // (we create them on original form before calling this)

    // append clone to body temporarily
    cloned.style.display = 'none';
    document.body.appendChild(cloned);

    try{
      await emailjs.sendForm('service_qjciobx','template_cpv6opc',cloned);
    }catch(err){ console.error('EmailJS error', err); throw err; }
    finally{ cloned.remove(); }
  }

  // Main submit flow: upload files, shorten, attach hidden fields (short) for email, send email, open whatsapp with full links
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    try{
      // 1) Upload files to Cloudinary (if any)
      const filesInput = form.querySelector('input[type="file"]');
      const uploaded = filesInput && filesInput.files.length ? await uploadFilesWithProgress(filesInput.files) : [];

      // 2) Shorten the uploaded URLs for email (limit to MAX_EMAIL_LINKS)
      const shortened = [];
      for(const u of uploaded){
        const short = await shortenUrl(u.url);
        shortened.push({name: u.name, full: u.url, short});
        // small delay to be gentle with is.gd
        await new Promise(r=>setTimeout(r,120));
      }

      // 3) Remove any previous file_link_* hidden inputs on form
      for(let i=1;i<=MAX_EMAIL_LINKS;i++){ const f = form.querySelector(`[name=file_link_${i}]`); if(f) f.remove(); }

      // 4) Create hidden inputs with short links for EmailJS (only up to MAX_EMAIL_LINKS)
      shortened.slice(0,MAX_EMAIL_LINKS).forEach((s,i)=>{
        const inp = document.createElement('input'); inp.type='hidden'; inp.name = `file_link_${i+1}`; inp.value = s.short; form.appendChild(inp);
      });

      // 5) Send data (without files) to EmailJS
      try{
        await sendEmailOnly();
        console.log('Email enviado con éxito');
      }catch(err){ console.warn('Fallo al enviar email, continuamos para WhatsApp', err); }

      // 6) Build WhatsApp message using full links (all uploaded)
      const d = new FormData(form);
      const fields = ['nombre','empresa','email','telefono','servicio','presupuesto','plazo','prioridad','referencias','descripcion'];
      const waLines = [];
      for(const f of fields){ if(d.get(f)) waLines.push(`${capitalize(f)}: ${d.get(f)}`); }
      if(uploaded.length){ waLines.push('Archivos subidos:'); uploaded.forEach(u=>waLines.push(`${u.name}: ${u.url}`)); }

      // open WhatsApp
      const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=` + encodeURIComponent(waLines.join('\n'));
      window.open(waUrl, '_blank');

      alert('Solicitud enviada al correo y se abrió WhatsApp.');
      form.reset(); updateSummary();
    }catch(err){ console.error(err); alert('Ocurrió un error: ' + (err.message||err)); }
  });

  function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
</script>

</body>
</html>
